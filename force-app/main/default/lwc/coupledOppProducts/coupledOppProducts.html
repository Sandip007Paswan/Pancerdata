<template>
    <div class="container">
        
        <template for:each={coupledItems} for:item="coupledItem">
            <div style="min-width:1200px" key={coupledItem.index} class="slds-timeline__item_expandable slds-is-open">
                <table class="slds-table slds-table_cell-buffer slds-table_bordered slds-table_col-bordered">
                    <thead>
                        <tr class="slds-line-height_reset">
                            <th class="" scope="col" style="width:20%">
                                <div class="slds-truncate" title="Coupled Product">Coupled Product</div>
                            </th>
                            <th class="" scope="col" style="width:15%">
                                <div class="slds-truncate" title="New Code">New Code</div>
                            </th>
                            <!--<th class="" scope="col" style="width: 15%;">
                                <div class="slds-truncate" title="Description">Description</div>
                            </th>-->
                            <th class="" scope="col" style="width: 10%;">
                                <div class="slds-truncate" title="UoM">UoM</div>
                            </th>
                            <template if:false={isSalesPerson}>
                                <th class="" scope="col" style="width:15%">
                                    <div class="slds-truncate" title="Overall Cost Price">Overall Cost Price</div>
                                </th>           
                                <th class="" scope="col" style="width:15%">
                                    <div class="slds-truncate" title="Overall Margin">Overall Margin</div>
                                </th>
                            </template>   
                            <th class="" scope="col" style="width:15%">
                                <div class="slds-truncate" title="Overall Sales Price">Overall Sales Price</div>
                            </th>  
                            <th class="" scope="col" style="width:15%">
                                <div class="slds-truncate" title="Quantity">Quantity</div>
                            </th>                                                                                                                  
                        </tr>
                    </thead>
                    <tbody>          
                        <tr>
                            <td data-label="Coupled Product">
                                <div class="slds-truncate" title="Coupled Product">                                    
                                    <lightning-layout>
                                        <lightning-layout-item style="line-height: 32px;width: 16px;padding-bottom:0;">
                                            <button class="slds-button slds-button_icon" onclick={toggleCoupledProduct} aria-controls="task-item-base">
                                                <lightning-icon icon-name="utility:switch" size="x-small" class="slds-button__icon slds-timeline__details-action-icon"></lightning-icon>
                                            </button>
                                        </lightning-layout-item>
                                        <template if:true={coupledItem.isRemoveable}>
                                            <lightning-layout-item class="slds-m-left_small">
                                                <lightning-icon icon-name="action:close" size="xx-small" alternative-text="Remove" title="Remove" style="cursor:pointer" onclick={removeCoupledProduct} data-index={coupledItem.index}></lightning-icon>
                                            </lightning-layout-item>     
                                        </template>
                                        <lightning-layout-item style="line-height: 32px; width: 100%;" class="slds-truncate slds-m-left_x-small">
                                            <lightning-input 
                                            type="text"                                            
                                            variant="label-hidden"
                                            name="Name"
                                            data-index={coupledItem.index}
                                            value={coupledItem.parentProduct.Name}
                                            onchange={coupledInputChanged}></lightning-input>                                                                                        
                                        </lightning-layout-item>            
                                    </lightning-layout>                                                              
                                </div>
                            </td>
                            <td data-label="New Code">
                                <div class="slds-truncate" title="New Code">
                                    <lightning-input 
                                    type="text"
                                    variant="label-hidden"
                                    data-index={coupledItem.index}
                                    name="Code__c"
                                    value={coupledItem.parentProduct.Code__c}
                                    onchange={coupledInputChanged}
                                    required></lightning-input>  
                                </div>
                            </td>
                            <!--<td data-label="Description">                                    
                                <lightning-textarea 
                                name="Description__c"
                                value={coupledItem.parentProduct.Description__c}
                                variant="label-hidden"
                                data-index={coupledItem.index}
                                onchange={coupledInputChanged}
                                ></lightning-textarea> 

                            </td> -->

                            <td data-label="Product UOM">
                                <lightning-combobox
                                class = "UOMCmp"
                                name="UOM__c"
                                variant="label-hidden"
                                data-index={coupledItem.index}
                                value={coupledItem.parentProduct.selectedOption}
                                options={coupledItem.parentProduct.Options}
                                onchange={coupledInputChanged} 
                                >
                            </lightning-combobox>
                            </td>  

                            <template if:false={isSalesPerson}>          
                            <td data-label="Cost Price" class="slds-text-align_center">
                                <lightning-input 
                                type="number"
                                name="Cost_Price__c"
                                value={coupledItem.parentProduct.Cost_Price__c}
                                min=0
                                step="0.01"
                                variant="label-hidden"
                                data-index={coupledItem.index}
                                onchange={coupledInputChanged}
                                disabled></lightning-input>                                       
                            </td>         
                            <td data-label="Margin %" class="slds-text-align_center">
                                <lightning-input 
                                type="number"
                                name="Margin__c"
                                value={coupledItem.parentProduct.Margin__c}
                                step="0.01"
                                formatter="percent-fixed"
                                variant="label-hidden"
                                data-index={coupledItem.index}
                                onchange={coupledInputChanged}
                                disabled></lightning-input>                                       
                            </td> 
                            </template>
                            
                            <td data-label="Sales Price" class="slds-text-align_center">
                                <lightning-input 
                                type="number"
                                name="Unit_Price__c"
                                value={coupledItem.parentProduct.Unit_Price__c}
                                min=0
                                step="0.01"
                                variant="label-hidden"
                                data-index={coupledItem.index}
                                onchange={coupledInputChanged}
                                disabled></lightning-input>                                       
                            </td> 
                            <td data-label="Quantity" class="slds-text-align_center">
                                <lightning-input 
                                type="number"
                                name="Quantity__c"
                                value={coupledItem.parentProduct.Quantity__c}                            
                                min=0
                                step="0.0001"
                                variant="label-hidden"
                                data-index={coupledItem.index}
                                onchange={coupledInputChanged}
                                disabled ></lightning-input>                                    
                            </td> 
                        </tr>       
                        <tr>
                            <td colspan="8">

                            <!-- START LINE ITEMS -->
                            <div style="min-width:1200px" class="slds-media_responsive lineItemTable">
                                <table class="slds-table slds-table_cell-buffer slds-table_bordered slds-table_col-bordered">
                                    <thead>
                                        <tr class="slds-line-height_reset">
                                            <th class="" scope="col" style="width:20%">
                                                <div class="slds-truncate" title="Component">Component</div>
                                            </th>
                                            <th class="" scope="col">
                                                <div class="slds-truncate" title="Code">Code</div>
                                            </th>

                                            <th class="" scope="col">
                                                <div class="slds-truncate" title="Qty Remain">Qty Remain</div>
                                            </th>
                                            
                                            <!--<th class="" scope="col" style="width: 15%;">
                                                <div class="slds-truncate" title="Description">Description</div>
                                            </th>-->
                
                                            <th class="" scope="col" style="width: 7%;">
                                                <div class="slds-truncate" title="UoM">UoM</div>
                                            </th>
                                            
                                            <template if:false={isSalesPerson}>
                                                <th class="" scope="col" style="width: 7%;">
                                                    <div class="slds-truncate" title="Cost Price">Cost Price</div>
                                                </th> 
                                            </template>     
                                            
                                            <th class="" scope="col" style="width: 7%;">
                                                <div class="slds-truncate" title="List Price">List Price</div>
                                            </th>
                                            
                                            <template if:false={isSalesPerson}>
                                                <th class="" scope="col" style="width: 7%;">
                                                    <div class="slds-truncate" title="Margin %">Margin %</div>
                                                </th>
                                            </template>      
                                            
                                            <th class="" scope="col">
                                                <div class="slds-truncate" title="Discount">Discount</div>
                                            </th>      
                                                       
                                            <th class="" scope="col" style="width: 7%;">
                                                <div class="slds-truncate" title="Sales Price">Sales Price</div>
                                            </th>                         

                                            <th class="" scope="col">
                                                <div class="slds-truncate" title="Quantity">Quantity</div>
                                            </th>  

                                            <th class="" scope="col">
                                                <div class="slds-truncate" title="Total Price">Total Sales Price</div>
                                            </th>                 
                                        </tr>
                                    </thead>
                                    
                                    <tbody>
                                        <template if:true={coupledItem.oppProducts}>
                                            <template for:each={coupledItem.oppProducts} for:item="item">
                                                <tr key={item.oppLineItem.Id}>          
                                                    <template if:false={item.isNew}>
                                                        <th data-label="Component Name" scope="row">
                                                            <lightning-layout>
                                                                <lightning-layout-item style="width: 35px;">
                                                                    <lightning-icon icon-name="action:close" size="xx-small" alternative-text="Remove" title="Remove" style="cursor:pointer" onclick={openDeleteProductModal} data-parentindex={coupledItem.index} data-index={item.index} data-id={item.oppLineItem.Id}></lightning-icon>
                                                                </lightning-layout-item>                                                
                                                                <lightning-layout-item style="line-height: 32px;" class="slds-truncate">
                                                                    <a href={item.productUrl} tabindex="-1" target="_blank">{item.oppLineItem.Product2.Name}</a>
                                                                </lightning-layout-item>
                                                            </lightning-layout>
                                                        </th>
                                                    </template>
                                                    <template if:true={item.isNew}>
                                                        <th data-label="Component Name" scope="row">
                                                            <lightning-layout>
                                                                <template if:true={item.isRemoveable}>
                                                                <lightning-layout-item>
                                                                    <lightning-icon icon-name="action:close" size="xx-small" alternative-text="Remove" title="Remove" style="cursor:pointer" onclick={removeProduct} data-parentindex={coupledItem.index} data-index={item.index}></lightning-icon>
                                                                </lightning-layout-item>
                                                                </template>
                                                                <div class="slds-col lookup1">
                                                                    <c-lookup
                                                                    data-parentindex={coupledItem.index}
                                                                    data-index={item.index}
                                                                    data-config={item.config}
                                                                    errors={item.errors}
                                                                    onsearch={handleSearch}
                                                                    onselectionchange={handleSelectionChange}
                                                                    placeholder={item.placeholderLabel}
                                                                    scroll-after-n-items="10"
                                                                >
                                                                </c-lookup>
                                                                </div>
                                                            </lightning-layout>
                                                        </th>
                                                    </template>
                                                    <td data-label="Code">
                                                        <div class="slds-truncate" title={item.oppLineItem.Product2.ProductCode}>{item.oppLineItem.Product2.ProductCode}</div>
                                                    </td> 

                                                    <td data-label="Qty Remain" class="slds-text-align_center">
                                                        <div class="slds-truncate" title={item.oppLineItem.Quantity_Remaining__c}>{item.oppLineItem.Quantity_Remaining__c}</div>                                   
                                                    </td>
                                                    
                                                    <!--<td data-label="Product Description">                                    
                                                        <lightning-textarea 
                                                        name="Description2__c"
                                                        value={item.oppLineItem.Description2__c}
                                                        variant="label-hidden"
                                                        data-parentindex={coupledItem.index}
                                                        data-index={item.index}
                                                        onchange={inputChanged}
                                                        ></lightning-textarea>                                                      
                                                    </td>-->
                                                    
                                                    <!--<td data-label="Product UOM">
                                                        <div class="slds-truncate" title={item.oppLineItem.Product2.UOM__c}>{item.oppLineItem.Product2.UOM__c}</div>
                                                    </td>-->

                                                    <td data-label="Product UOM">
                                                        <lightning-combobox
                                                        class = "UOMCmp"
                                                        name="UOM__c"
                                                        variant="label-hidden"
                                                        data-parentindex={coupledItem.index}
                                                        data-index={item.index}
                                                        value={item.oppLineItem.selectedOption}
                                                        options={item.oppLineItem.Options}
                                                        onchange={UOMChangeHandler} 
                                                        >
                                                    </lightning-combobox>
                                                    </td>  
                                                                    
                                                    <template if:false={isSalesPerson}>
                                                        <td data-label="Cost Price" class="slds-text-align_center">
                                                            <lightning-input 
                                                            type="number"
                                                            name="Cost_Price__c"
                                                            value={item.oppLineItem.Cost_Price__c}
                                                            min=0
                                                            step="0.01"
                                                            variant="label-hidden"
                                                            data-parentindex={coupledItem.index}
                                                            data-index={item.index}
                                                            onchange={inputChanged}
                                                            ></lightning-input>                                       
                                                        </td>
                                                    </template>

                                                    <td data-label="List Price" class="slds-text-align_center">
                                                        <lightning-input 
                                                        type="number"
                                                        name="ListPrice"
                                                        value={item.oppLineItem.ListPrice}
                                                        step="0.01"
                                                        variant="label-hidden"
                                                        data-parentindex={coupledItem.index}
                                                        data-index={item.index}
                                                        onchange={inputChanged}
                                                        required disabled></lightning-input>                                       
                                                    </td>                
                                                    
                                                    <template if:false={isSalesPerson}>
                                                    <td data-label="Margin %" class="slds-text-align_center">
                                                        <lightning-input 
                                                        type="number"
                                                        name="Margin__c"
                                                        value={item.oppLineItem.Margin__c}
                                                        step="0.01"
                                                        formatter="percent-fixed"
                                                        variant="label-hidden"
                                                        data-parentindex={coupledItem.index}
                                                        data-index={item.index}
                                                        onchange={inputChanged}
                                                        required disabled></lightning-input>                                       
                                                    </td> 
                                                    </template>
                                                    <td data-label="Discount" class="slds-text-align_center">
                                                        <lightning-input 
                                                        type="number"
                                                        name="Discount"
                                                        value={item.oppLineItem.Discount}
                                                        step="0.01"
                                                        min = "0"
                                                        max = "100"
                                                        formatter="percent-fixed"
                                                        variant="label-hidden"
                                                        data-parentindex={coupledItem.index}
                                                        data-index={item.index}
                                                        onchange={inputChanged}
                                                        required></lightning-input>                                       
                                                    </td>
                                                                                    
                                        
                                                    <td data-label="Sales Price" class="slds-text-align_center">
                                                        <lightning-input 
                                                        type="number"
                                                        name="UnitPrice"
                                                        value={item.oppLineItem.UnitPrice}
                                                        min=0
                                                        step="0.01"
                                                        variant="label-hidden"
                                                        data-parentindex={coupledItem.index}
                                                        data-index={item.index}
                                                        onchange={inputChanged}
                                                        required></lightning-input>                                       
                                                    </td> 
                                                                                    
                                                    <td data-label="Quantity" class="slds-text-align_center">
                                                        <lightning-input 
                                                        type="number"
                                                        name="Quantity"
                                                        value={item.oppLineItem.Quantity}
                                                        min=0
                                                        step="0.0001"
                                                        variant="label-hidden"
                                                        data-parentindex={coupledItem.index}
                                                        data-index={item.index}
                                                        onchange={inputChanged}
                                                        required></lightning-input>                                    
                                                    </td>                                         
                                                    <td data-label="Total Price" class="">
                                                        <div class="slds-truncate" title={item.oppLineItem.TotalPrice}>
                                                            <lightning-formatted-number 
                                                            value={item.oppLineItem.TotalPrice} 
                                                            format-style="currency"
                                                            currency-code="MYR" 
                                                            currency-display-as="symbol"
                                                            minimum-fraction-digits="2"
                                                            maximum-fraction-digits="2"></lightning-formatted-number>                                            
                                                        </div>                              
                                                    </td> 
                                                </tr>
                                            </template> 
                                        </template>
                                        <tr>                                            
                                            <td colspan="11">
                                                <div class="slds-text-align_left">
                                                    <lightning-button variant="brand" label="Add Product" title="Add Product" onclick={addProduct} data-parentindex={coupledItem.index}></lightning-button>
                                                </div>
                                            </td>                                        
                                        </tr>          
                                    </tbody>                    
                                </table>
                            </div>
                            <!-- END LINE ITEMS -->

                            </td>
                        </tr>        
                                          
                    </tbody>
                </table>
            </div>                        
        </template>
        
        <div class="slds-var-m-top_small">
            <lightning-button variant="brand" label="Add Coupled Product" title="Add Coupled Product" onclick={addCoupledProduct}></lightning-button>
        </div>

        
        
        <div class="slds-text-align_center slds-var-m-top_small">
            <lightning-button variant="brand" label="Save Product(s)" title="Save Product(s)" onclick={saveCoupledProducts} data-close="false"></lightning-button>   &nbsp;  
            <lightning-button variant="brand" label="Save Product(s) and Close" title="Save Product(s) and Close" onclick={saveCoupledProducts} data-close="true"></lightning-button>            
        </div>
        
        <template if:true={showSpinner}>
            <lightning-spinner
                variant="brand"
                size="large">
            </lightning-spinner>
        </template>

    </div>      
    
    <template if:true={showDeleteProductModal}>
        <section
            role="dialog"
            tabindex="-1"
            aria-labelledby="modal-heading-01"
            aria-modal="true"
            aria-describedby="modal-content-id-1"
            class="slds-modal slds-fade-in-open slds-modal_small"
        >
            <div class="slds-modal__container" style="width:20rem;min-width:20rem;">
                <header class="slds-modal__header">
                    <lightning-button-icon
                        class="slds-modal__close"
                        title="Close"
                        icon-name="utility:close"
                        icon-class="slds-button_icon-inverse"
                        onclick={closeDeleteProductModal}
                    ></lightning-button-icon>
                    <h2 class="slds-text-heading_medium slds-hyphenate header-string">
                        Confirm Delete
                    </h2>
                </header>

                <div class="slds-modal__content slds-p-around_medium slds-text-align_center" id="modal-content-id-1">
                    <p>Are you sure?</p>
                </div>

                <footer class="slds-modal__footer modal-hidden">
                    <lightning-button onclick={deleteProduct} data-id={productToDeleteId} data-parentindex={productToDeleteParentIndex} data-index={productToDeleteIndex} variant="destructive" label="Delete"></lightning-button>&nbsp;
                    <lightning-button onclick={closeDeleteProductModal} variant="neutral" label="Cancel"></lightning-button>
                </footer>

            </div>
        </section>
        <div class="slds-backdrop slds-backdrop_open"></div>
    </template>

</template>